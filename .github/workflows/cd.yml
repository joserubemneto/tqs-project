name: CD - Deploy to Production

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual trigger

# Prevent concurrent deployments
concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  JAVA_VERSION: '25'
  NODE_VERSION: '24'

jobs:
  # Detect which paths changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Backend CI - only if backend changed
  ci-backend:
    name: Backend CI
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Build and test backend
        run: mvn clean verify -B
        env:
          SPRING_PROFILES_ACTIVE: test

  # Frontend CI - only if frontend changed
  ci-frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint and type check
        run: |
          pnpm check
          pnpm exec tsc --noEmit

      - name: Run tests
        run: pnpm test:run

      - name: Build
        run: pnpm build

  # Deploy backend - only if backend changed and CI passed
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [changes, ci-backend]
    if: needs.changes.outputs.backend == 'true' && needs.ci-backend.result == 'success'
    environment: production

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}"
          echo "Backend deployment triggered"

  # Deploy frontend - only if frontend changed and CI passed
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [changes, ci-frontend]
    if: needs.changes.outputs.frontend == 'true' && needs.ci-frontend.result == 'success'
    environment: production

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}"
          echo "Frontend deployment triggered"

  # Verify backend deployment
  verify-backend:
    name: Verify Backend
    runs-on: ubuntu-latest
    needs: [changes, deploy-backend]
    if: needs.changes.outputs.backend == 'true'

    steps:
      - name: Wait for deployment
        run: sleep 120

      - name: Check backend health
        run: |
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.BACKEND_URL }}/api/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i: Backend returned $response, waiting..."
            sleep 30
          done
          echo "Backend health check failed"
          exit 1

  # Verify frontend deployment
  verify-frontend:
    name: Verify Frontend
    runs-on: ubuntu-latest
    needs: [changes, deploy-frontend]
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Check frontend availability
        run: |
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.FRONTEND_URL }}" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Frontend is available!"
              exit 0
            fi
            echo "Attempt $i: Frontend returned $response, waiting..."
            sleep 30
          done
          echo "Frontend availability check failed"
          exit 1
